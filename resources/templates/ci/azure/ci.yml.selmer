# Only runs on pull requests that 
# Only runs on pull requests that target `main`
# We use uv to dynamically apply the python version in .python-version
trigger: none

pr:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

jobs:
  - job: CI
    displayName: "CI"
    steps:
      - checkout: self

      # Install uv
      - script: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
        displayName: "Install uv"

      # Create venv & sync all dependency groups from pyproject.toml
      - script: |
          uv venv
          uv sync --all-groups
        displayName: "Create & sync venv with uv"

      # Lint
      - script: |
          uv run ruff check .
        displayName: "Lint"

      # Type-check
      - script: |
          uv run mypy .
        displayName: "Type-check"

      # Tests
      - script: |
          uv run pytest --junitxml=reports/test-results.xml
        displayName: "Run tests"

      - task: PublishTestResults@2
        displayName: "Publish test results"
        inputs:
          testResultsFiles: "reports/test-results.xml"
          testRunTitle: "PyTest Results"
      {% if project_type = "dabs" %}
      # Install Databricks CLI & validate bundle
      - script: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          databricks bundle validate
        displayName: "Validate bundle"
        env:
          DATABRICKS_CLIENT_ID: $(DATABRICKS_CLIENT_ID)
          DATABRICKS_CLIENT_SECRET: $(DATABRICKS_CLIENT_SECRET)
      {% endif %}
      # Build wheel {% if project_type = "dabs" %}(just to catch packaging issues){% endif %}
      - script: |
        uv build displayName: "Build wheel"
      {% if project_type = "python-lib" %}
      - task: publishbuildartifacts@1
        inputs:
          pathtopublish: "$(build.sourcesdirectory)/dist"
          artifactname: "dist"
          publishlocation: "container"
        displayname: "publish wheel artefacts"
      {% endif %}
